<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>ระบบจัดตารางเรียนและตารางสอน</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ระบบล็อกอิน -->
  <div id="loginModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <h2 style="text-align: center; margin-bottom: 20px;">เข้าสู่ระบบ</h2>
      <div style="margin-bottom: 15px;">
        <label>รหัสผ่านผู้ดูแลระบบ:</label>
        <input type="password" id="adminPassword" style="width: 100%; padding: 10px; border: 1px solid #d1fae5; border-radius: 6px;" placeholder="กรอกรหัสผ่าน" />
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn-primary" id="loginBtn" style="flex: 1;">เข้าสู่ระบบ (Admin)</button>
        <button class="btn-secondary" id="guestBtn" style="flex: 1;">เข้าสู่ระบบเป็นผู้เยี่ยมชม</button>
      </div>
      <div id="loginMessage" style="margin-top: 10px; text-align: center;"></div>
    </div>
  </div>

  <div class="container" id="mainApp" style="display: none;">
    <header>
      <img src="https://tkk911.github.io/Schedule_Manager_LTC/logoLTC.png" alt="LTC Logo" />
      <h2>ระบบจัดการตารางเรียนและตารางสอน</h2>
      <h1>วิทยาลัยเทคโนโลยีแหลมทอง</h1>
      <div class="sub">กลุ่มงาน ไฟฟ้าและอิเล็กทรอนิกส์</div>
      <div class="term">
        ภาคเรียน:
        <input type="text" id="termInput" value="ภาคเรียนที่ 2/2568" />
      </div>
      <div id="userInfo" style="margin-top: 10px; font-size: 14px; display: flex; justify-content: center; align-items: center; gap: 10px;">
        <span id="userStatus"></span>
        <button id="logoutBtn" class="btn-secondary small" style="display: none;">ออกจากระบบ</button>
      </div>
    </header>

    <div class="layout">
      <!-- ตารางเรียนของนักศึกษา/ตารางสอนของอาจารย์/ เต็มพื้นที่ด้านบน -->
      <div class="card">
        <h2>ตารางเรียนของนักศึกษา/ตารางสอนของอาจารย์/ ตารางห้องเรียน</h2>
        <div id="tabArea" class="tabs">
          <div class="tab active" data-type="all">ตารางรวม</div>
          <div class="tab" data-type="teacher">อาจารย์</div>
          <div class="tab" data-type="class">นักเรียน (ชั้น)</div>
          <div class="tab" data-type="room">ห้อง</div>
        </div>
        <div id="filterBox" style="margin-bottom:10px; display:none;">
          <select id="filterSelect" style="padding:6px; border-radius:6px; border:1px solid #ccc; width:200px;"></select>
        </div>
        <div class="grid-wrap">
          <table id="mainGrid">
            <thead>
              <tr>
                <th>วัน/เวลา</th>
                <th>คาบ 1<div>(08:30-09:20)</div></th>
                <th>คาบ 2<div>(09:20-10:10)</div></th>
                <th>คาบ 3<div>(10:20-11:10)</div></th>
                <th>คาบ 4<div>(11:10-12:00)</div></th>
                <th>พักกลางวัน<div>(12.00-12:50)</div></th>
                <th>คาบ 5<div>(12:50-13:40)</div></th>
                <th>คาบ 6<div>(13:40-14:30)</div></th>
                <th>คาบ 7<div>(14:30-15:20)</div></th>
              </tr>
            </thead>
            <tbody id="gridBody">				
            </tbody>
          </table>
        </div>
      </div>

      <!-- layout เดิม: ซ้าย (ฟอร์ม+สรุป) / ขวา (รายการทั้งหมด) -->
      <div style="display:grid;grid-template-columns:380px 1fr;gap:14px">
        <div>
          <div class="card" id="controls">
            <h2>เพิ่ม/แก้ไข รายการสอน</h2>
            
            <!-- เพิ่มปุ่มจัดการข้อมูล JSON และ Google Sheets -->
            <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;">
              <button type="button" id="testConnectionBtn" class="btn-primary">ทดสอบการเชื่อมต่อ</button>
              <button type="button" id="saveLessonsBtn" class="btn-primary">บันทึกตารางเรียนเท่านั้น</button>
              <button type="button" id="saveAllFastBtn" class="btn-primary">บันทึกทั้งหมดแบบเร็ว</button>
              <button type="button" id="downloadJsonBtn" class="btn-primary">ดาวน์โหลด JSON</button>
              <button type="button" id="importJsonBtn" class="btn-secondary">นำเข้า JSON</button>
              <button type="button" id="exportToSheetsBtn" class="btn-primary">ส่งข้อมูลไป Google Sheets</button>
              <button type="button" id="exportToSheetsChunkBtn" class="btn-info">ส่งข้อมูลแบบแบ่งชุด</button>
              <button type="button" id="importFromSheetsBtn" class="btn-secondary">โหลดข้อมูลจาก Google Sheets</button>
              <button type="button" id="clearDataBtn" class="btn-danger" style="display:none;">ล้างข้อมูลทั้งหมด</button>
              <button type="button" id="debugBtn" class="btn-info" style="display:none;">Debug ข้อมูล</button>
              <input type="file" id="jsonFileInput" accept=".json" style="display:none" />
            </div>
            
            <form id="lessonForm">
              <div class="row">
                <div style="flex:1">
                  <label>อาจารย์</label>
                  <select id="teacher" required>
                    <option value="">เลือกอาจารย์</option>
                  </select>
                  <div class="data-management">
                    <h4>จัดการรายชื่ออาจารย์</h4>
                    <div class="input-group">
                      <input type="text" id="newTeacher" placeholder="ชื่ออาจารย์" />
                      <button type="button" class="btn-info" id="addTeacher">เพิ่ม</button>
                    </div>
                    <div class="data-list" id="teacherList"></div>
                  </div>
                </div>
                <div style="flex:1">
                  <label>ชั้นเรียน</label>
                  <select id="classLevel" required>
                    <option value="">เลือกชั้นเรียน</option>
                  </select>
                  <div class="data-management">
                    <h4>จัดการชั้นเรียน</h4>
                    <div class="input-group">
                      <input type="text" id="newClass" placeholder="ชื่อชั้นเรียน" />
                      <button type="button" class="btn-info" id="addClass">เพิ่ม</button>
                    </div>
                    <div class="data-list" id="classList"></div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div style="flex:1">
                  <label>ชื่อวิชา</label>
                  <select id="subject" required>
                    <option value="">เลือกรายวิชา</option>
                  </select>
                  <div class="data-management">
                    <h4>จัดการรายวิชา</h4>
                    <div class="input-group">
                      <input type="text" id="newSubject" placeholder="ชื่อรายวิชา" />
                      <button type="button" class="btn-info" id="addSubject">เพิ่ม</button>
                    </div>
                    <div class="data-list" id="subjectList"></div>
                  </div>
                </div>
                <div style="flex:1">
                  <label>ห้อง</label>
                  <select id="room" required>
                    <option value="">เลือกห้อง</option>
                  </select>
                  <div class="data-management">
                    <h4>จัดการห้องเรียน</h4>
                    <div class="input-group">
                      <input type="text" id="newRoom" placeholder="ชื่อห้อง" />
                      <button type="button" class="btn-info" id="addRoom">เพิ่ม</button>
                    </div>
                    <div class="data-list" id="roomList"></div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div style="flex:1">
                  <label>วัน</label>
                  <select id="day">
                    <option value="0">จันทร์</option>
                    <option value="1">อังคาร</option>
                    <option value="2">พุธ</option>
                    <option value="3">พฤหัสบดี</option>
                    <option value="4">ศุกร์</option>
                  </select>
                </div>
                <div style="flex:1">
                  <label>คาบ</label>
                  <select id="period">
                    <option value="0">คาบ 1</option>
                    <option value="1">คาบ 2</option>
                    <option value="2">คาบ 3</option>
                    <option value="3">คาบ 4</option>
                    <option value="5">คาบ 5</option>
                    <option value="6">คาบ 6</option>
                    <option value="7">คาบ 7</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div style="flex:1">
                  <label>จำนวนคาบ</label>
                  <input type="number" id="numPeriods" value="1" min="1" max="7" />
                </div>
              </div>

              <div style="display:flex;gap:8px;margin-top:10px">
                <button class="btn-primary" type="submit" id="submitBtn">บันทึก</button>
                <button type="button" id="autoBtn" class="btn-primary">เพิ่มอัตโนมัติ</button>
                <button type="button" id="resetBtn" class="btn-secondary">รีเซ็ต</button>
                <div style="margin-left:auto;display:flex;gap:6px">
                  <button type="button" id="exportBtn" class="btn-primary">Export Excel</button>
                  <button type="button" id="printBtn" class="btn-secondary">Print PDF</button>
                </div>
              </div>
              <div id="message" style="margin-top:10px"></div>
            </form>
          </div>

          <div class="card">
            <h3>สรุปคาบสอน (อาจารย์) & สรุปรายวิชาตามชั้นปี</h3>
            
            <!-- เพิ่มแท็บสำหรับเลือกประเภทสรุป -->
            <div class="summary-tabs" style="display: flex; margin-bottom: 10px; border-bottom: 1px solid #d1fae5;">
              <div class="summary-tab active" data-type="teacher">สรุปอาจารย์</div>
              <div class="summary-tab" data-type="class">สรุปชั้นปี</div>
            </div>
            
            <!-- ส่วนสรุปอาจารย์ (เดิม) -->
            <div id="teacherSummarySection">
              <div class="summary-controls" style="margin-bottom:10px;">
                <select id="teacherSummarySelect" style="padding:6px; border-radius:6px; border:1px solid #ccc; width:100%;">
                  <option value="all">แสดงทั้งหมด</option>
                </select>
              </div>
              <div id="teacherSummary" class="summary small"></div>
            </div>
            
            <!-- ส่วนสรุปชั้นปี (ใหม่) -->
            <div id="classSummarySection" style="display: none;">
              <div class="summary-controls" style="margin-bottom:10px;">
                <select id="classSummarySelect" style="padding:6px; border-radius:6px; border:1px solid #ccc; width:100%;">
                  <option value="all">แสดงทั้งหมด</option>
                </select>
              </div>
              <div id="classSummary" class="summary small"></div>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <h2>รายการจัดการเรียนทั้งหมด</h2>
            
            <!-- เพิ่มส่วนกรองข้อมูล -->
            <div class="filter-controls" style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
              <div>
                <label>กรองตามรายวิชา:</label>
                <select id="filterSubject" style="padding: 6px; border-radius: 6px; border: 1px solid #ccc; width: 150px;">
                  <option value="">ทั้งหมด</option>
                </select>
              </div>
              <div>
                <label>กรองตามครู:</label>
                <select id="filterTeacher" style="padding: 6px; border-radius: 6px; border: 1px solid #ccc; width: 150px;">
                  <option value="">ทั้งหมด</option>
                </select>
              </div>
              <div>
                <label>กรองตามชั้น:</label>
                <select id="filterClass" style="padding: 6px; border-radius: 6px; border: 1px solid #ccc; width: 150px;">
                  <option value="">ทั้งหมด</option>
                </select>
              </div>
              <div>
                <label>กรองตามห้อง:</label>
                <select id="filterRoom" style="padding: 6px; border-radius: 6px; border: 1px solid #ccc; width: 150px;">
                  <option value="">ทั้งหมด</option>
                </select>
              </div>
              <div>
                <label>กรองตามวัน:</label>
                <select id="filterDay" style="padding: 6px; border-radius: 6px; border: 1px solid #ccc; width: 120px;">
                  <option value="">ทั้งหมด</option>
                  <option value="0">จันทร์</option>
                  <option value="1">อังคาร</option>
                  <option value="2">พุธ</option>
                  <option value="3">พฤหัสบดี</option>
                  <option value="4">ศุกร์</option>
                </select>
              </div>
              <div>
                <label>กรองตามคาบ:</label>
                <select id="filterPeriod" style="padding: 6px; border-radius: 6px; border: 1px solid #ccc; width: 120px;">
                  <option value="">ทั้งหมด</option>
                  <option value="0">คาบ 1</option>
                  <option value="1">คาบ 2</option>
                  <option value="2">คาบ 3</option>
                  <option value="3">คาบ 4</option>
                  <option value="5">คาบ 5</option>
                  <option value="6">คาบ 6</option>
                  <option value="7">คาบ 7</option>
                </select>
              </div>
              <div style="align-self: end;">
                <button type="button" id="resetFilterBtn" class="btn-secondary" style="padding: 6px 12px;">รีเซ็ตการกรอง</button>
              </div>
            </div>
            
            <table id="lessonTable">
              <thead>
                <tr><th>วิชา</th><th>ครู</th><th>ชั้น</th><th>ห้อง</th><th>วัน</th><th>คาบ</th><th>จัดการ</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal สำหรับแก้ไขข้อมูล -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modalTitle">แก้ไขข้อมูล</h3>
      <input type="text" id="editInput" />
      <div style="display:flex;gap:8px;margin-top:15px">
        <button class="btn-primary" id="saveEditBtn">บันทึก</button>
        <button class="btn-secondary" id="cancelEditBtn">ยกเลิก</button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner (แก้ไขแล้ว) -->
  <div id="loading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 18px; flex-direction: column;">
    <div style="background: white; padding: 30px; border-radius: 10px; color: black; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); flex-direction: column;">
      <div class="loading-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite;"></div>
      <div style="text-align: center;">
        <div style="font-weight: bold; margin-bottom: 5px;">🔄 กำลังโหลดข้อมูล...</div>
        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">กรุณารอสักครู่</div>
        <button onclick="forceHideLoading()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">
          🚫 ยกเลิกการโหลด
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="script.js"></script>
</body>
</html>
